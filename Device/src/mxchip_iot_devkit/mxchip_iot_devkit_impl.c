/*******************************************************************************************
 * This code was automatically generated by Digital Twin Code Generator tool 0.6.0.
 *
 * You need to add your implementation here to:
 *    - get telemetry data from device/sensor
 *    - set read-only property data
 *    - handle read-write property callback
 *    - process device command
 *
 * Generated Date: Friday, August 9, 2019
 *******************************************************************************************/

#include "IoT_DevKit_HW.h"
#include "mxchip_iot_devkit_impl.h"
#include "utilities/digitaltwin_serializer.h"
#include "utilities/deviceinfo_interface.h"
#include "utilities/sensors_interface.h"
#include "utilities/leds_interface.h"
#include "utilities/position_interface.h"
#include "utilities/screen_interface.h"
#include "utilities/settings_interface.h"

#include "ui/screen.h"
#include "ui/screen_animation.h"

#include "pnp_statistics.h"

#include "pgmspace.h"

double Sensors_Telemetry_ReadHumidity()
{
    return getDevKitHumidityValue();
}

double Sensors_Telemetry_ReadTemperature()
{
    return getDevKitTemperatureValue(0);
}

double Sensors_Telemetry_ReadPressure()
{
    return getDevKitPressureValue();
}

void Sensors_Telemetry_ReadMagnetometer(SENSORS_MAGNETOMETER * magnetometer)
{
    if (magnetometer)
    {
        getDevKitMagnetometerValue(&magnetometer->x, &magnetometer->y, &magnetometer->z);
    }
}

void Sensors_Telemetry_ReadGyroscope(SENSORS_GYROSCOPE * gyroscope)
{
    if (gyroscope)
    {
        getDevKitGyroscopeValue(&gyroscope->x, &gyroscope->y, &gyroscope->z);
    }
}

void Sensors_Telemetry_ReadAccelerometer(SENSORS_ACCELEROMETER * accelerometer)
{
    if (accelerometer)
    {
        getDevKitAcceleratorValue(&accelerometer->x, &accelerometer->y, &accelerometer->z);
    }
}

void SendTelemetry_Succeeded_Callback(const char* interfaceName, const char* telemetryName)
{
    telemetry_sent_inc();
}

void SendTelemetry_Error_Callback(const char* interfaceName, const char* telemetryName)
{
    error_inc();
}

void ReportProperty_Succeeded_Callback(const char* interfaceName, const char* propertyName)
{
    int last_setting_change = 0;
    int last_setting_value = 0;
    get_last_setting_change(&last_setting_change, &last_setting_value);
    if (get_telemetry_sent_number() > 0)
    {
        switch(last_setting_change)
        {
        case SETTING_CHANGE_FANSPEED:
            play_fanspeed_animation(last_setting_value);
            break;
        case SETTING_CHANGE_CURRENT:
            play_current_animation(last_setting_value);
            break;
        case SETTING_CHANGE_VOLTAGE:
            play_voltage_animation(last_setting_value);
            break;
        case SETTING_CHANGE_IRDA:
            play_irda_animation(last_setting_value);
            break;
        }
    }
    setting_change(SETTING_CHANGE_NONE, 0);
}

void ReportProperty_Error_Callback(const char* interfaceName, const char* propertyName)
{
    setting_change(SETTING_CHANGE_NONE, 0);
    error_inc();
}

char* Deviceinfo_Property_GetManufacturer()
{
    return "MXChip";
}

char* Deviceinfo_Property_GetModel()
{
    return "AZ3166";
}

char* Deviceinfo_Property_GetSwVersion()
{
    return "1.0.0";
}

char* Deviceinfo_Property_GetOsName()
{
    return "Arm Mbed OS v5.2";
}

char* Deviceinfo_Property_GetProcessorArchitecture()
{
    return "Arm Cortex M4";
}

char* Deviceinfo_Property_GetProcessorManufacturer()
{
    return "STMicro";
}

long Deviceinfo_Property_GetTotalStorage()
{
    return  2048L;
}

long Deviceinfo_Property_GetTotalMemory()
{
    return 256L;
}

bool Settings_Property_FanSpeedCallback(double fanSpeed)
{
    setting_change(SETTING_CHANGE_FANSPEED, (int)fanSpeed);
    return true;
}

bool Settings_Property_VoltageCallback(double voltage)
{
    setting_change(SETTING_CHANGE_VOLTAGE, (int)voltage);
    return true;
}

bool Settings_Property_CurrentCallback(double current)
{
    setting_change(SETTING_CHANGE_CURRENT, (int)current);
    return true;
}

bool Settings_Property_IrSwitchCallback(bool irSwitch)
{
    setting_change(SETTING_CHANGE_IRDA, (int)irSwitch);
    return true;
}

DIGITALTWIN_COMMAND_RESULT ModelDefinition_Command_GetModelDefinition(char* id, char** response, unsigned int* statusCode)
{
    // Note: The only interface ID we're expecting to be quieried for is urn:contoso:position:1 so we don't bother checking the "id"

    LogInfo("Parameter: id = %s", id);

    char* responseData = "{\r\n  \"@id\": \"urn:contoso:position:1\",\r\n  \"@type\": \"Interface\",\r\n  \"displayName\": \"A Location\",\r\n  \"contents\": [\r\n    {\r\n      \"@type\": \"Telemetry\",\r\n      \"name\": \"location\",\r\n      \"displayName\": \"A GPS Position\",\r\n      \"comment\": \"This shows a complex telemetry that contains a GPS reading.\",\r\n      \"schema\": {\r\n        \"@type\": \"Object\",\r\n        \"fields\": [\r\n          {\r\n            \"name\": \"lat\",\r\n            \"schema\": \"double\"\r\n          },\r\n          {\r\n            \"name\": \"lon\",\r\n            \"schema\": \"double\"\r\n          },\r\n          {\r\n            \"name\": \"alt\",\r\n            \"schema\": \"double\"\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  ],\r\n  \"@context\": \"http://azureiot.com/v1/contexts/IoTModel.json\"\r\n}";
    *response = (char*)calloc(strlen(responseData) + 1, sizeof(char));
    strncpy(*response, responseData, strlen(responseData));

    *statusCode = 200;
    LogInfo("Device executed 'getModelDefinition' command successfully");
    return DIGITALTWIN_COMMAND_OK;
}

DIGITALTWIN_COMMAND_RESULT Leds_Command_Blink(long interval, LEDS_BLINK_blinkResponse* response, unsigned int* statusCode)
{
    if (interval > 0 && interval < 60)
    {
        startBlinkDevKitRGBLED(interval * 1000);
        response->description = "Start blinking";
    }
    else
    {
        response->description = "Invalid interval";
    }
    
    *statusCode = 200;
    LogInfo("Device executed 'blink' command successfully");
    return DIGITALTWIN_COMMAND_OK;
}

DIGITALTWIN_COMMAND_RESULT Leds_Command_TurnOnLed(unsigned int* statusCode)
{
    turnOnUserLED();
    *statusCode = 200;
    LogInfo("Execute 'turnOnLed' command successfully");
    return DIGITALTWIN_COMMAND_OK;
}

DIGITALTWIN_COMMAND_RESULT Leds_Command_TurnOffLed(unsigned int* statusCode)
{
    turnOffUserLED();
    *statusCode = 200;
    LogInfo("Execute 'turnOffLed' command successfully");
    return DIGITALTWIN_COMMAND_OK;
}

DIGITALTWIN_COMMAND_RESULT Screen_Command_Echo(char* text, SCREEN_ECHO_echoResponse* response, unsigned int* statusCode)
{
    LogInfo("Parameter: text = %s", text);

    screen_echo(text);

    response->echo = text;

    *statusCode = 200;
    LogInfo("Device executed 'echo' command successfully");
    return DIGITALTWIN_COMMAND_OK;
}

DIGITALTWIN_COMMAND_RESULT Screen_Command_Countdown(int number, unsigned int* statusCode)
{
    LogInfo("Countdown number = %d", number);
        
    play_countdown_animation(number);

    *statusCode = 200;
    LogInfo("Execute 'countdown' command successfully");
    return DIGITALTWIN_COMMAND_OK;
}

#define POSITION_ARR_LENGTH 380
const float PROGMEM LATITUDES[] = { 47.60322,47.60328,47.60361,47.60374,47.60394,47.6044,47.60488,47.60498,47.60499,47.60505,47.60508,47.60512,47.60514,47.60519,47.60525,47.60542,47.60572,47.60681,47.60744,47.60817,47.60885,47.60889,47.60894,47.60927,47.6097,47.60992,47.61047,47.61052,47.61057,47.61062,47.61102,47.61115,47.61215,47.61264,47.61297,47.61316,47.61325,47.61338,47.61425,47.61456,47.61475,47.61504,47.61543,47.61597,47.61622,47.61691,47.61848,47.61889,47.61934,47.61971,47.61981,47.62029,47.62197,47.62353,47.62426,47.62448,47.6249,47.6251,47.62669,47.62742,47.62828,47.62883,47.62985,47.63046,47.63124,47.63174,47.63245,47.6336,47.63379,47.63487,47.63525,47.63558,47.63585,47.63603,47.63623,47.63632,47.63672,47.63762,47.63824,47.63866,47.63937,47.63945,47.6411,47.64149,47.6418,47.64191,47.6422,47.64237,47.64238,47.64241,47.64265,47.64266,47.64269,47.64284,47.64288,47.64291,47.643,47.64307,47.64311,47.64312,47.64313,47.64323,47.64328,47.64335,47.6434,47.64349,47.64376,47.64381,47.64394,47.64398,47.64407,47.64421,47.64424,47.64425,47.64428,47.64437,47.64437,47.64437,47.64441,47.64448,47.64455,47.64456,47.64472,47.64481,47.64487,47.64489,47.645,47.64512,47.64512,47.64498,47.64493,47.6449,47.64487,47.64486,47.64484,47.64473,47.64472,47.64471,47.64449,47.64437,47.64422,47.6439,47.64376,47.64369,47.64368,47.64339,47.64286,47.64229,47.64126,47.64104,47.64087,47.64024,47.63854,47.63808,47.63793,47.6377,47.63756,47.63744,47.63715,47.63707,47.63679,47.63672,47.63661,47.63634,47.63634,47.63626,47.6362,47.63617,47.63599,47.63577,47.6358,47.63581,47.63585,47.63586,47.63587,47.63594,47.63618,47.63672,47.63674,47.63735,47.63891,47.63958,47.64002,47.64013,47.64026,47.64029,47.64039,47.64144,47.6421,47.64229,47.64268,47.64274,47.64287,47.64294,47.64288,47.64273,47.64262,47.64248,47.64215,47.64213,47.6421,47.64173,47.64138,47.64119,47.6407,47.64027,47.64003,47.63981,47.63969,47.63942,47.63753,47.6369,47.63672,47.63596,47.63518,47.63383,47.63324,47.63319,47.63312,47.63264,47.63242,47.63234,47.63229,47.63226,47.6322,47.63219,47.63216,47.63208,47.6319,47.63188,47.63187,47.63187,47.63187,47.63188,47.63188,47.6319,47.63192,47.63188,47.63186,47.63183,47.63172,47.63168,47.6316,47.63116,47.6306,47.63056,47.63046,47.62993,47.62973,47.62969,47.62967,47.62967,47.62982,47.62985,47.62988,47.63007,47.63005,47.62959,47.6294,47.62939,47.62941,47.62955,47.62956,47.62968,47.62995,47.63046,47.6306,47.63102,47.63152,47.63202,47.63264,47.63309,47.6343,47.63433,47.63672,47.63741,47.63775,47.63816,47.63921,47.64006,47.64039,47.64056,47.64159,47.64259,47.64356,47.6445,47.64544,47.64597,47.64606,47.64914,47.6495,47.65069,47.65201,47.65318,47.65435,47.65443,47.6546,47.65602,47.65703,47.65869,47.65984,47.6606,47.6608,47.66133,47.66343,47.66436,47.66496,47.66558,47.66605,47.66614,47.66616,47.66605,47.66579,47.66559,47.66528,47.66513,47.66524,47.66532,47.66538,47.66559,47.66602,47.66654,47.66691,47.66709,47.66724,47.66741,47.66793,47.66832,47.66847,47.66853,47.66855,47.66873,47.66898,47.66913,47.66924,47.66941,47.66948,47.66967,47.66977,47.66996,47.67026,47.67034,47.67041,47.67053,47.6706,47.67068,47.67079,47.67084,47.6709,47.67094,47.67103,47.67109,47.67134,47.67156,47.67176,47.67181,47.67196,47.67206,47.67224,47.67234,47.67237,47.67256,47.67271,47.67276,47.6728,47.67289,47.67303,47.67309,47.67326,47.67342,47.67355,47.6736,47.67369,47.67378,47.67381,47.6739,47.67394,47.67419,47.67487,47.6749 } ;
const float PROGMEM LONGITUDES[] = { -122.33029,-122.33034,-122.33065,-122.33077,-122.33096,-122.32987,-122.32876,-122.32849,-122.32845,-122.3283,-122.32823,-122.32813,-122.32808,-122.32799,-122.32796,-122.32797,-122.32817,-122.32915,-122.32974,-122.33036,-122.33081,-122.33082,-122.33084,-122.33093,-122.33099,-122.33101,-122.33098,-122.33097,-122.33097,-122.33096,-122.33086,-122.33082,-122.33047,-122.33029,-122.33017,-122.33009,-122.33005,-122.33001,-122.3297,-122.32957,-122.3295,-122.32938,-122.32923,-122.32902,-122.32893,-122.3287,-122.32835,-122.3283,-122.32824,-122.32821,-122.3282,-122.32818,-122.32814,-122.32814,-122.32815,-122.32815,-122.32816,-122.32816,-122.32814,-122.328,-122.32764,-122.32726,-122.3263,-122.32566,-122.32489,-122.32446,-122.32402,-122.32353,-122.32345,-122.32305,-122.32295,-122.32286,-122.32281,-122.32279,-122.32275,-122.32274,-122.32271,-122.32266,-122.32266,-122.32265,-122.32249,-122.32247,-122.32232,-122.32213,-122.32178,-122.32167,-122.32103,-122.32025,-122.32019,-122.32008,-122.3186,-122.31853,-122.31818,-122.31671,-122.3164,-122.31613,-122.3152,-122.31327,-122.31111,-122.31075,-122.3105,-122.30935,-122.30911,-122.30873,-122.30848,-122.30809,-122.30682,-122.30655,-122.30598,-122.30577,-122.30538,-122.30466,-122.30451,-122.30441,-122.30422,-122.30311,-122.30266,-122.30207,-122.30074,-122.30028,-122.2998,-122.29971,-122.29881,-122.29828,-122.29788,-122.29773,-122.29708,-122.29563,-122.29456,-122.2921,-122.29125,-122.29102,-122.29057,-122.29033,-122.28997,-122.28841,-122.28831,-122.28805,-122.28461,-122.2829,-122.28096,-122.27899,-122.27819,-122.27783,-122.27777,-122.27627,-122.27303,-122.26917,-122.2625,-122.26111,-122.25995,-122.25586,-122.24496,-122.24241,-122.24164,-122.24066,-122.24009,-122.23959,-122.23847,-122.23816,-122.23687,-122.23638,-122.23579,-122.23389,-122.23387,-122.23334,-122.23296,-122.23266,-122.23148,-122.22951,-122.22819,-122.22809,-122.2278,-122.22767,-122.22763,-122.22717,-122.22573,-122.22432,-122.22425,-122.22314,-122.22085,-122.2195,-122.21824,-122.2179,-122.21749,-122.21736,-122.2171,-122.21386,-122.21191,-122.21137,-122.20995,-122.20965,-122.20885,-122.20754,-122.20632,-122.20488,-122.20407,-122.20308,-122.20145,-122.20137,-122.20129,-122.20009,-122.19921,-122.1988,-122.19786,-122.19723,-122.1969,-122.19663,-122.19644,-122.19612,-122.19373,-122.19299,-122.19282,-122.19212,-122.1916,-122.19067,-122.19002,-122.18994,-122.18986,-122.18904,-122.18854,-122.18833,-122.18819,-122.18809,-122.18791,-122.18789,-122.18781,-122.18746,-122.1862,-122.18563,-122.18503,-122.18487,-122.18444,-122.18427,-122.18403,-122.18297,-122.18259,-122.18105,-122.18076,-122.18045,-122.17973,-122.17946,-122.17901,-122.1773,-122.17532,-122.17519,-122.17485,-122.17295,-122.17196,-122.17151,-122.1703,-122.17022,-122.16797,-122.16756,-122.16714,-122.16442,-122.16372,-122.15929,-122.15713,-122.15551,-122.15512,-122.15374,-122.15364,-122.15295,-122.15176,-122.15014,-122.14979,-122.14887,-122.14798,-122.14709,-122.146,-122.14521,-122.14311,-122.14306,-122.13897,-122.13778,-122.13731,-122.13679,-122.13575,-122.13513,-122.13493,-122.13484,-122.13442,-122.13421,-122.13416,-122.13428,-122.13457,-122.1348,-122.13485,-122.13629,-122.13646,-122.13701,-122.13749,-122.1377,-122.13772,-122.13771,-122.1377,-122.13743,-122.13706,-122.1362,-122.13559,-122.13519,-122.13508,-122.13481,-122.13366,-122.13297,-122.13231,-122.13139,-122.13014,-122.12971,-122.12913,-122.12856,-122.12804,-122.12781,-122.12746,-122.12715,-122.12711,-122.12709,-122.12701,-122.12694,-122.12682,-122.12675,-122.12677,-122.12681,-122.12686,-122.12692,-122.12724,-122.1276,-122.12777,-122.12784,-122.12795,-122.12821,-122.12868,-122.129,-122.1291,-122.12917,-122.12916,-122.12904,-122.12888,-122.1286,-122.12812,-122.128,-122.1279,-122.12774,-122.12763,-122.12753,-122.12735,-122.12727,-122.12719,-122.12711,-122.12695,-122.12679,-122.12618,-122.12565,-122.12516,-122.125,-122.12465,-122.12441,-122.12402,-122.12384,-122.1238,-122.12362,-122.12351,-122.12348,-122.12344,-122.12339,-122.12333,-122.12329,-122.12321,-122.12313,-122.12306,-122.12304,-122.12299,-122.12294,-122.12292,-122.12288,-122.12285,-122.12273,-122.12239,-122.124 } ;

int locationIdx = 0;

void Position_Telemetry_ReadLocation(POSITION_LOCATION * location)
{
    location->lat = LATITUDES[locationIdx];
    location->lon = LONGITUDES[locationIdx];

    locationIdx = (locationIdx + 1) % POSITION_ARR_LENGTH;

    location->alt = 0.0;

}
